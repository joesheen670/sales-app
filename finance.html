<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è²¡å‹™ç´€éŒ„ Finance</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }

        /* â”€â”€ Loading â”€â”€ */
        .loading-overlay {
            display: flex; position: fixed; inset: 0;
            background: rgba(0,0,0,0.75); z-index: 3000;
            justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin-bottom: 14px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Toast â”€â”€ */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(80px);
            background: #333; color: white; padding: 12px 24px;
            border-radius: 25px; font-size: 14px; font-weight: 600;
            z-index: 2000; transition: transform 0.3s ease; white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* â”€â”€ Nav â”€â”€ */
        .nav-bar {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-title { color: white; font-size: 18px; font-weight: 700; }
        .nav-link {
            color: rgba(255,255,255,0.6); font-size: 13px;
            text-decoration: none; padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px; transition: all 0.2s;
        }
        .nav-link:hover { color: white; border-color: rgba(255,255,255,0.5); }

        /* â”€â”€ Container â”€â”€ */
        .container { max-width: 960px; margin: 0 auto; padding: 20px 16px 80px; }

        /* â”€â”€ Summary Cards â”€â”€ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; margin-bottom: 20px;
        }
        @media (min-width: 600px) { .summary-grid { grid-template-columns: repeat(4, 1fr); } }

        .summary-card {
            background: rgba(255,255,255,0.08);
            border-radius: 16px; padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .summary-card.green  { border-color: rgba(76,217,100,0.4); }
        .summary-card.red    { border-color: rgba(233,69,96,0.4); }
        .summary-card.yellow { border-color: rgba(255,204,0,0.4); }
        .summary-card.blue   { border-color: rgba(90,200,250,0.4); }

        .summary-label { color: rgba(255,255,255,0.5); font-size: 12px; margin-bottom: 6px; }
        .summary-value { color: white; font-size: 22px; font-weight: 700; }
        .summary-card.green  .summary-value { color: #4cd964; }
        .summary-card.red    .summary-value { color: #e94560; }
        .summary-card.yellow .summary-value { color: #ffcc00; }
        .summary-card.blue   .summary-value { color: #5ac8fa; }

        /* â”€â”€ Tabs â”€â”€ */
        .tabs {
            display: flex; gap: 8px; margin-bottom: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px; padding: 6px;
        }
        .tab {
            flex: 1; padding: 10px; border: none;
            background: transparent; color: rgba(255,255,255,0.5);
            border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
        }
        .tab.active { background: #e94560; color: white; }

        .view { display: none; }
        .view.active { display: block; }

        /* â”€â”€ Filters â”€â”€ */
        .filters {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px;
        }
        .filters input, .filters select {
            flex: 1; min-width: 120px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px; color: white; font-size: 14px;
        }
        .filters input::placeholder { color: rgba(255,255,255,0.35); }
        .filters input:focus, .filters select:focus {
            outline: none; border-color: #e94560;
        }
        .filters select option { background: #1a1a2e; color: white; }

        /* â”€â”€ Table â”€â”€ */
        .table-wrap {
            background: rgba(255,255,255,0.05);
            border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 680px; }

        thead { background: rgba(233,69,96,0.2); }
        th {
            padding: 12px 14px; text-align: left;
            color: rgba(255,255,255,0.7); font-size: 13px;
            font-weight: 600; white-space: nowrap;
        }
        tbody tr {
            border-top: 1px solid rgba(255,255,255,0.05);
            transition: background 0.15s;
        }
        tbody tr:hover { background: rgba(255,255,255,0.05); }
        td {
            padding: 11px 14px; color: rgba(255,255,255,0.85);
            font-size: 14px;
        }
        td.id-col { color: rgba(255,255,255,0.35); font-size: 12px; }
        td.buyer-col { font-weight: 600; color: white; }

        /* Profit colours */
        .profit-positive { color: #4cd964; font-weight: 700; }
        .profit-negative { color: #e94560; font-weight: 700; }
        .profit-zero     { color: rgba(255,255,255,0.4); }

        /* â”€â”€ Inline edit â”€â”€ */
        .amount-cell { display: flex; align-items: center; gap: 6px; }
        .amount-input {
            width: 90px; padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: white; font-size: 14px;
            text-align: right;
        }
        .amount-input:focus { outline: none; border-color: #e94560; background: rgba(233,69,96,0.15); }
        .amount-input.dirty { border-color: #ffcc00; }
        .amount-input.saved { border-color: #4cd964; }

        .save-row-btn {
            padding: 5px 10px; border: none;
            background: #e94560; color: white;
            border-radius: 8px; cursor: pointer; font-size: 13px;
            white-space: nowrap; transition: opacity 0.2s;
        }
        .save-row-btn:disabled { opacity: 0.4; cursor: default; }
        .save-row-btn.saved-state { background: #4cd964; }

        /* â”€â”€ Result count â”€â”€ */
        .result-count { padding: 10px 14px; color: rgba(255,255,255,0.4); font-size: 13px; }

        /* â”€â”€ Batch save bar â”€â”€ */
        .batch-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #e94560; color: white;
            border-radius: 25px; padding: 12px 28px;
            font-size: 14px; font-weight: 700;
            box-shadow: 0 4px 20px rgba(233,69,96,0.5);
            cursor: pointer; z-index: 500;
            display: none; align-items: center; gap: 10px;
            transition: transform 0.3s;
        }
        .batch-bar.visible { display: flex; }
        .batch-bar:hover { transform: translateX(-50%) scale(1.03); }

        /* â”€â”€ Stats page â”€â”€ */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
        }
        @media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr; } }

        .stat-box {
            background: rgba(255,255,255,0.06);
            border-radius: 16px; padding: 18px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-box h3 { color: rgba(255,255,255,0.6); font-size: 13px; margin: 0 0 12px; }

        .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .bar-label { width: 80px; font-size: 13px; color: rgba(255,255,255,0.6); text-align: right; flex-shrink: 0; }
        .bar-track { flex: 1; background: rgba(255,255,255,0.07); border-radius: 4px; overflow: hidden; }
        .bar-fill {
            height: 24px; border-radius: 4px;
            background: linear-gradient(90deg, #e94560, #a855f7);
            display: flex; align-items: center; justify-content: flex-end;
            padding-right: 8px; color: white; font-size: 12px; font-weight: 600;
            transition: width 0.5s ease; min-width: 30px;
        }
        .bar-fill.profit-bar { background: linear-gradient(90deg, #059669, #4cd964); }

        /* â”€â”€ Month profit chart â”€â”€ */
        .month-profit-bar { background: linear-gradient(90deg, #0ea5e9, #a855f7); }

        /* â”€â”€ No data â”€â”€ */
        .no-data {
            text-align: center; padding: 40px;
            color: rgba(255,255,255,0.3); font-size: 15px;
        }

        /* â”€â”€ Modal â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1e2235; border-radius: 20px;
            padding: 28px; width: 92%; max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal h2 { color: white; margin: 0 0 20px; font-size: 18px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 6px; color: rgba(255,255,255,0.6); font-size: 13px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 11px 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px; color: white; font-size: 15px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #e94560;
        }
        .form-group select option { background: #1e2235; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 13px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { opacity: 0.85; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
        .btn-secondary:hover { opacity: 0.75; }

        /* â”€â”€ FAB â”€â”€ */
        .fab {
            position: fixed; bottom: 80px; right: 20px;
            width: 52px; height: 52px;
            background: #e94560; color: white;
            border: none; border-radius: 50%;
            font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 16px rgba(233,69,96,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 400; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }

        /* â”€â”€ Helper â”€â”€ */
        .shipping-tag {
            font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
        }
        .tag-711    { background: rgba(255,149,0,0.2); color: #ff9500; }
        .tag-family { background: rgba(76,217,100,0.2); color: #4cd964; }
        .tag-home   { background: rgba(90,200,250,0.2); color: #5ac8fa; }

        .cost-badge {
            font-size: 11px; padding: 2px 7px; border-radius: 8px;
            background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.45);
            margin-left: 4px;
        }
    </style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay hidden" id="loading">
    <div class="spinner"></div>
    <div id="loading-text">è¼‰å…¥ä¸­...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Nav -->
<div class="nav-bar">
    <div class="nav-title">ï¿½ è²¡å‹™ç¸½è¦½</div>
    <a href="cost-input.html" class="nav-link">ğŸ§¾ æˆæœ¬è¼¸å…¥</a>
    <a href="index.html" class="nav-link">ğŸ“¦ éŠ·å”®ç´€éŒ„</a>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="edit-modal">
    <div class="modal">
        <h2 id="edit-modal-title">âœï¸ è¼¸å…¥é‡‘é¡</h2>
        <div class="form-group">
            <label>è¨‚å–®ç·¨è™Ÿ</label>
            <input type="text" id="edit-id" readonly style="opacity:0.5;">
        </div>
        <div class="form-group">
            <label>è²·å®¶</label>
            <input type="text" id="edit-buyer" readonly style="opacity:0.5;">
        </div>
        <div class="form-group">
            <label>ğŸ’µ éŠ·å”®é‡‘é¡ï¼ˆå…ƒï¼‰</label>
            <input type="number" id="edit-sale" placeholder="0" min="0" step="1">
        </div>
        <div class="form-group">
            <label>ğŸ“¦ å•†å“æˆæœ¬ï¼ˆå…ƒï¼‰</label>
            <input type="number" id="edit-cost" placeholder="0" min="0" step="1">
        </div>
        <div class="form-group">
            <label>ğŸšš é‹è²»ï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</label>
            <input type="number" id="edit-shipping-cost" placeholder="0" min="0" step="1">
        </div>
        <div id="edit-profit-preview" style="
            margin-top:8px; padding:12px; border-radius:10px;
            background:rgba(255,255,255,0.05); color:white; text-align:center;
            font-size:16px; font-weight:700; display:none;">
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="modal-save-btn" onclick="saveFromModal()">âœ“ å„²å­˜</button>
        </div>
    </div>
</div>

<!-- Batch Save Bar -->
<div class="batch-bar" id="batch-bar" onclick="saveAllDirty()">
    ğŸ’¾ å„²å­˜ <span id="dirty-count">0</span> ç­†ä¿®æ”¹
</div>

<!-- Main -->
<div class="container">

    <!-- Summary -->
    <div class="summary-grid">
        <div class="summary-card blue">
            <div class="summary-label">ç¸½éŠ·å”®é¡</div>
            <div class="summary-value" id="s-total-sale">$0</div>
        </div>
        <div class="summary-card red">
            <div class="summary-label">ç¸½æˆæœ¬</div>
            <div class="summary-value" id="s-total-cost">$0</div>
        </div>
        <div class="summary-card green">
            <div class="summary-label">ç¸½åˆ©æ½¤</div>
            <div class="summary-value" id="s-total-profit">$0</div>
        </div>
        <div class="summary-card yellow">
            <div class="summary-label">åˆ©æ½¤ç‡</div>
            <div class="summary-value" id="s-margin">0%</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showTab('list', this)">ğŸ“‹ è¼¸å…¥é‡‘é¡</button>
        <button class="tab" onclick="showTab('stats', this)">ğŸ“Š åˆ©æ½¤çµ±è¨ˆ</button>
    </div>

    <!-- â”€â”€ List Tab â”€â”€ -->
    <div class="view active" id="tab-list">
        <div class="filters">
            <input type="text" id="search" placeholder="ğŸ” æœå°‹è²·å®¶..." oninput="renderTable()">
            <select id="filter-month" onchange="renderTable()">
                <option value="">å…¨éƒ¨æœˆä»½</option>
            </select>
            <select id="filter-status" onchange="renderTable()">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="filled">å·²å¡«é‡‘é¡</option>
                <option value="empty">æœªå¡«é‡‘é¡</option>
            </select>
        </div>

        <div class="table-wrap">
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>æ—¥æœŸ</th>
                            <th>è²·å®¶</th>
                            <th>è²¨é‹</th>
                            <th>éŠ·å”®é¡ $</th>
                            <th>æˆæœ¬ $</th>
                            <th>åˆ©æ½¤ $</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            <div class="result-count" id="result-count"></div>
        </div>
    </div>

    <!-- â”€â”€ Stats Tab â”€â”€ -->
    <div class="view" id="tab-stats">
        <div class="stats-grid">
            <div class="stat-box">
                <h3>ğŸ“… æ¯æœˆåˆ©æ½¤</h3>
                <div id="chart-monthly"></div>
            </div>
            <div class="stat-box">
                <h3>ğŸ† è²·å®¶åˆ©æ½¤ Top 10</h3>
                <div id="chart-buyer"></div>
            </div>
        </div>
        <br>
        <div class="stat-box">
            <h3>ğŸšš è²¨é‹åˆ©æ½¤æ¯”è¼ƒ</h3>
            <div id="chart-shipping"></div>
        </div>
    </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  è¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://script.google.com/macros/s/AKfycbztxJ_ylpecd_cgE-JdV1zYhGt_FmvMsjEdWrMI7ALEQxGG1kABteGQusz8Vx4uGRbZ/exec';

// è²¡å‹™è³‡æ–™å­˜æ”¾æ–¼ localStorageï¼ˆkey: finance_<id>ï¼‰
// æ ¼å¼ï¼š{ sale: æ•¸å­—, cost: æ•¸å­—, shippingCost: æ•¸å­— }

let salesData   = [];   // å¾ Google Sheets ä¾†çš„è¨‚å–®
let financeData = {};   // å¾ localStorage ä¾†çš„é‡‘é¡è³‡æ–™ { id -> {sale, cost, shippingCost} }
let dirtySet    = new Set();  // å·²ä¿®æ”¹ä½†æœªå„²å­˜åˆ° Sheets çš„ id

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
    loadFinanceFromLocal();
    await loadSalesData();
    populateMonthFilter();
    renderTable();
    renderStats();
}

// â”€â”€ å¾ localStorage è®€å–è²¡å‹™è³‡æ–™ â”€â”€
function loadFinanceFromLocal() {
    financeData = {};
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('finance_')) {
            const id = key.replace('finance_', '');
            try { financeData[id] = JSON.parse(localStorage.getItem(key)); }
            catch(e) {}
        }
    }
}

// â”€â”€ å„²å­˜ä¸€ç­†è²¡å‹™åˆ° localStorage â”€â”€
function saveFinanceToLocal(id, data) {
    localStorage.setItem('finance_' + id, JSON.stringify(data));
    financeData[id] = data;
}

// â”€â”€ å¾ Google Sheets è¼‰å…¥è¨‚å–® â”€â”€
async function loadSalesData() {
    showLoading('è¼‰å…¥è¨‚å–®è³‡æ–™...');
    try {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 30000);
        const res = await fetch(API_URL, { signal: ctrl.signal });
        clearTimeout(t);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const raw = await res.json();
        salesData = raw.map(d => ({
            id:           String(d.id || ''),
            date:         String(d.date || ''),
            buyer:        String(d.buyer || ''),
            shipping:     String(d.shipping || ''),
            region:       String(d.region || ''),
        }));
        showToast('âœ“ å·²è¼‰å…¥ ' + salesData.length + ' ç­†è¨‚å–®');
    } catch(e) {
        showToast('âš ï¸ ç„¡æ³•è¼‰å…¥è¨‚å–®ï¼š' + e.message);
        salesData = [];
    }
    hideLoading();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å·¥å…·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFinance(id) {
    return financeData[id] || { sale: 0, cost: 0, shippingCost: extractShippingCost(id) };
}

function extractShippingCost(id) {
    const rec = salesData.find(d => d.id === id);
    if (!rec) return 0;
    const m = rec.shipping.match(/\((\d+)\)/);
    return m ? parseInt(m[1]) : 0;
}

function calcProfit(f) {
    return (f.sale || 0) - (f.cost || 0) - (f.shippingCost || 0);
}

function getShippingType(shipping) {
    if (!shipping) return 'other';
    if (shipping.includes('7-11')) return '7-11';
    if (shipping.includes('å…¨å®¶'))  return 'å…¨å®¶';
    if (shipping.includes('å®…é…'))  return 'å®…é…';
    return 'å…¶ä»–';
}

function fmtMoney(n) {
    return (n >= 0 ? '+' : '') + n.toLocaleString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Tabs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(name, btn) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    btn.classList.add('active');
    if (name === 'stats') renderStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Summary Bar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSummary(rows) {
    let totSale = 0, totCost = 0, totProfit = 0;
    rows.forEach(rec => {
        const f = getFinance(rec.id);
        totSale   += f.sale   || 0;
        totCost   += (f.cost || 0) + (f.shippingCost || 0);
        totProfit += calcProfit(f);
    });
    document.getElementById('s-total-sale').textContent   = '$' + totSale.toLocaleString();
    document.getElementById('s-total-cost').textContent   = '$' + totCost.toLocaleString();
    document.getElementById('s-total-profit').textContent = (totProfit >= 0 ? '+$' : '-$') + Math.abs(totProfit).toLocaleString();
    const margin = totSale > 0 ? Math.round(totProfit / totSale * 100) : 0;
    document.getElementById('s-margin').textContent       = margin + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFilteredRows() {
    const search  = document.getElementById('search').value.toLowerCase();
    const month   = document.getElementById('filter-month').value;
    const status  = document.getElementById('filter-status').value;

    return salesData.filter(rec => {
        if (search && !rec.buyer.toLowerCase().includes(search) && !rec.id.includes(search)) return false;
        if (month) {
            // date format: M/D/YYYY or YYYY-MM-DD
            const d = rec.date;
            const mMatch = d.match(/^(\d+)\//);  // M/D/YYYY
            const yMatch = d.match(/^\d{4}-(\d+)-/); // YYYY-MM-DD
            const recMonth = mMatch ? mMatch[1] : (yMatch ? parseInt(yMatch[1]).toString() : '');
            if (recMonth !== month) return false;
        }
        if (status) {
            const f = getFinance(rec.id);
            const filled = f.sale > 0 || f.cost > 0;
            if (status === 'filled' && !filled) return false;
            if (status === 'empty'  &&  filled) return false;
        }
        return true;
    });
}

function renderTable() {
    const rows = getFilteredRows();
    updateSummary(rows);

    const tbody = document.getElementById('table-body');

    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8"><div class="no-data">æ²’æœ‰ç¬¦åˆçš„ç´€éŒ„</div></td></tr>';
        document.getElementById('result-count').textContent = '';
        return;
    }

    tbody.innerHTML = rows.map(rec => {
        const f      = getFinance(rec.id);
        const profit = calcProfit(f);
        const type   = getShippingType(rec.shipping);
        const tagCls = type === '7-11' ? 'tag-711' : type === 'å…¨å®¶' ? 'tag-family' : 'tag-home';
        const profitCls = profit > 0 ? 'profit-positive' : profit < 0 ? 'profit-negative' : 'profit-zero';
        const profitTxt = profit === 0 && !f.sale ? 'â€“' : fmtMoney(profit);
        const saleTxt  = f.sale   ? '$' + f.sale.toLocaleString()   : 'â€“';
        const costTxt  = f.cost   ? '$' + f.cost.toLocaleString()   : 'â€“';
        const scBadge  = f.shippingCost ? `<span class="cost-badge">é‹$${f.shippingCost}</span>` : '';

        return `<tr>
            <td class="id-col">${rec.id}</td>
            <td>${rec.date}</td>
            <td class="buyer-col">${rec.buyer}</td>
            <td><span class="shipping-tag ${tagCls}">${type}</span></td>
            <td>${saleTxt}</td>
            <td>${costTxt}${scBadge}</td>
            <td class="${profitCls}">${profitTxt}</td>
            <td><button class="save-row-btn" onclick="openEditModal('${rec.id}')">âœï¸</button></td>
        </tr>`;
    }).join('');

    document.getElementById('result-count').textContent =
        `é¡¯ç¤º ${rows.length} / ${salesData.length} ç­†`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentEditId = null;

function openEditModal(id) {
    const rec = salesData.find(d => d.id === id);
    if (!rec) return;
    const f = getFinance(id);

    currentEditId = id;
    document.getElementById('edit-id').value            = rec.id;
    document.getElementById('edit-buyer').value         = rec.buyer;
    document.getElementById('edit-sale').value          = f.sale   || '';
    document.getElementById('edit-cost').value          = f.cost   || '';
    document.getElementById('edit-shipping-cost').value = f.shippingCost !== undefined
        ? f.shippingCost : extractShippingCost(id);

    document.getElementById('edit-modal-title').textContent = `âœï¸ #${id} ${rec.buyer}`;
    updateProfitPreview();
    document.getElementById('edit-modal').classList.add('active');

    // Live profit preview
    ['edit-sale','edit-cost','edit-shipping-cost'].forEach(elId => {
        document.getElementById(elId).oninput = updateProfitPreview;
    });
}

function updateProfitPreview() {
    const sale = parseFloat(document.getElementById('edit-sale').value) || 0;
    const cost = parseFloat(document.getElementById('edit-cost').value) || 0;
    const sc   = parseFloat(document.getElementById('edit-shipping-cost').value) || 0;
    const profit = sale - cost - sc;
    const el = document.getElementById('edit-profit-preview');
    el.style.display = 'block';
    if (sale === 0 && cost === 0) { el.style.display = 'none'; return; }
    el.textContent = `é ä¼°åˆ©æ½¤ï¼š${fmtMoney(profit)} å…ƒ`;
    el.style.color  = profit > 0 ? '#4cd964' : profit < 0 ? '#e94560' : 'white';
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.remove('active');
    currentEditId = null;
}

async function saveFromModal() {
    const id   = currentEditId;
    const sale = parseFloat(document.getElementById('edit-sale').value) || 0;
    const cost = parseFloat(document.getElementById('edit-cost').value) || 0;
    const sc   = parseFloat(document.getElementById('edit-shipping-cost').value) || 0;

    const data = { sale, cost, shippingCost: sc };
    saveFinanceToLocal(id, data);

    // å˜—è©¦åŒæ­¥åˆ° Google Sheetsï¼ˆfinance sheetï¼‰
    document.getElementById('modal-save-btn').disabled = true;
    const ok = await syncFinanceToSheet(id, data);
    document.getElementById('modal-save-btn').disabled = false;

    closeEditModal();
    renderTable();
    renderStats();
    showToast(ok ? 'âœ“ å·²å„²å­˜ä¸¦åŒæ­¥' : 'âœ“ å·²å„²å­˜ï¼ˆæœ¬åœ°ï¼‰âš ï¸ åŒæ­¥å¤±æ•—');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync to Google Sheets
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncFinanceToSheet(id, data) {
    try {
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action:       'updateFinance',
                id:           id,
                sale:         data.sale,
                cost:         data.cost,
                shippingCost: data.shippingCost,
                profit:       data.sale - data.cost - data.shippingCost
            })
        });
        return true;
    } catch(e) {
        return false;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Stats
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
    renderMonthlyChart();
    renderBuyerChart();
    renderShippingChart();
}

function renderMonthlyChart() {
    const monthMap = {};
    salesData.forEach(rec => {
        const f = getFinance(rec.id);
        if (!f.sale && !f.cost) return;
        const m = rec.date.match(/^(\d+)\//);
        const ym = rec.date.match(/^(\d{4}-\d{2})/);
        const key = m ? (m[1] + 'æœˆ') : (ym ? ym[1] : '?');
        if (!monthMap[key]) monthMap[key] = { sale:0, profit:0 };
        monthMap[key].sale   += f.sale || 0;
        monthMap[key].profit += calcProfit(f);
    });

    const entries = Object.entries(monthMap).sort((a,b) => a[0].localeCompare(b[0]));
    const container = document.getElementById('chart-monthly');

    if (!entries.length) { container.innerHTML = '<div class="no-data">å°šç„¡è³‡æ–™</div>'; return; }

    const maxProfit = Math.max(...entries.map(([,v]) => Math.abs(v.profit)), 1);
    container.innerHTML = entries.map(([month, v]) => {
        const pct = Math.round(Math.abs(v.profit) / maxProfit * 90);
        const cls = v.profit >= 0 ? 'profit-bar' : '';
        const lbl = (v.profit >= 0 ? '+$' : '-$') + Math.abs(v.profit).toLocaleString();
        return `<div class="bar-row">
            <div class="bar-label">${month}</div>
            <div class="bar-track"><div class="bar-fill ${cls}" style="width:${pct}%">${lbl}</div></div>
        </div>`;
    }).join('');
}

function renderBuyerChart() {
    const buyerMap = {};
    salesData.forEach(rec => {
        const f = getFinance(rec.id);
        if (!f.sale && !f.cost) return;
        if (!buyerMap[rec.buyer]) buyerMap[rec.buyer] = 0;
        buyerMap[rec.buyer] += calcProfit(f);
    });

    const top = Object.entries(buyerMap).sort((a,b) => b[1]-a[1]).slice(0,10);
    const container = document.getElementById('chart-buyer');

    if (!top.length) { container.innerHTML = '<div class="no-data">å°šç„¡è³‡æ–™</div>'; return; }

    const maxVal = Math.max(...top.map(([,v]) => Math.abs(v)), 1);
    container.innerHTML = top.map(([name, profit]) => {
        const pct = Math.round(Math.abs(profit) / maxVal * 90);
        const cls = profit >= 0 ? 'profit-bar' : '';
        const lbl = (profit >= 0 ? '+$' : '-$') + Math.abs(profit).toLocaleString();
        return `<div class="bar-row">
            <div class="bar-label" title="${name}">${name.substring(0,5)}</div>
            <div class="bar-track"><div class="bar-fill ${cls}" style="width:${pct}%">${lbl}</div></div>
        </div>`;
    }).join('');
}

function renderShippingChart() {
    const map = {};
    salesData.forEach(rec => {
        const f = getFinance(rec.id);
        if (!f.sale && !f.cost) return;
        const type = getShippingType(rec.shipping);
        if (!map[type]) map[type] = { profit:0, count:0 };
        map[type].profit += calcProfit(f);
        map[type].count++;
    });

    const entries = Object.entries(map);
    const container = document.getElementById('chart-shipping');

    if (!entries.length) { container.innerHTML = '<div class="no-data">å°šç„¡è³‡æ–™</div>'; return; }

    const maxVal = Math.max(...entries.map(([,v]) => Math.abs(v.profit)), 1);
    container.innerHTML = entries.map(([type, v]) => {
        const pct = Math.round(Math.abs(v.profit) / maxVal * 90);
        const cls = v.profit >= 0 ? 'profit-bar' : '';
        const avg = v.count > 0 ? Math.round(v.profit / v.count) : 0;
        const lbl = (v.profit >= 0 ? '+$' : '-$') + Math.abs(v.profit).toLocaleString() + ` (å‡${avg})`;
        return `<div class="bar-row">
            <div class="bar-label">${type}</div>
            <div class="bar-track"><div class="bar-fill ${cls}" style="width:${pct}%">${lbl}</div></div>
        </div>`;
    }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Month Filter
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateMonthFilter() {
    const months = [...new Set(salesData.map(d => {
        const m = d.date.match(/^(\d+)\//);
        return m ? m[1] : null;
    }).filter(Boolean))].sort((a,b) => parseInt(a)-parseInt(b));

    const sel = document.getElementById('filter-month');
    sel.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>' +
        months.map(m => `<option value="${m}">${m}æœˆ</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(txt) {
    document.getElementById('loading-text').textContent = txt || 'è™•ç†ä¸­...';
    document.getElementById('loading').classList.remove('hidden');
}
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

document.getElementById('edit-modal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Start
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
