<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="éŠ·å”®ç®¡ç† v2">
    <title>éŠ·å”®ç®¡ç† v2</title>
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Reset & Variables
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

:root {
    --bg:        #f0f4f8;
    --s1:        #ffffff;
    --s2:        #e8edf2;
    --s3:        #d0d7de;
    --border:    rgba(0,0,0,0.1);
    --text:      #1c2128;
    --dim:       #57606a;

    /* ç‹€æ…‹è‰² */
    --c-new:     #58a6ff;   /* æ–°è¨‚å–® */
    --c-paid:    #d29922;   /* å·²æ”¶æ¬¾ */
    --c-ship:    #a855f7;   /* å‡ºè²¨ä¸­ */
    --c-done:    #3fb950;   /* å®Œæˆ */
    --c-cancel:  #6e7681;   /* å–æ¶ˆ */

    --red:   #e94560;
    --green: #3fb950;
    --blue:  #58a6ff;
    --gold:  #d29922;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding-bottom: 80px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Loading
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-overlay {
    display: flex; position: fixed; inset: 0;
    background: rgba(240,244,248,0.95); z-index: 9999;
    flex-direction: column; justify-content: center; align-items: center; gap: 14px;
}
.loading-overlay.hidden { display: none; }
.spinner {
    width: 38px; height: 38px;
    border: 3px solid rgba(255,255,255,0.08);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: var(--dim); font-size: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
    position: fixed; bottom: 90px; left: 50%;
    transform: translateX(-50%) translateY(60px);
    background: var(--s1); color: var(--text);
    padding: 10px 20px; border-radius: 20px;
    font-size: 13px; font-weight: 600;
    border: 1px solid var(--border);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 5000; transition: transform .25s ease; white-space: nowrap;
    pointer-events: auto; cursor: pointer;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.ok  { border-color: var(--green); }
.toast.err { border-color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Top Bar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
    position: sticky; top: 0; z-index: 300;
    background: rgba(240,244,248,0.97);
    backdrop-filter: blur(14px);
    border-bottom: 1px solid var(--border);
    height: 54px;
    display: flex; align-items: center;
    padding: 0 16px; gap: 12px;
}
.topbar-title { font-size: 16px; font-weight: 700; flex: 1; }
.topbar-badge {
    font-size: 14px; font-weight: 700; padding: 5px 14px;
    background: rgba(88,166,255,0.15);
    color: var(--blue); border-radius: 10px;
    border: 1px solid rgba(88,166,255,0.35);
}
.btn-add {
    display: flex; align-items: center; gap: 6px;
    background: var(--blue); color: white;
    border: none; border-radius: 8px;
    padding: 8px 14px; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: opacity .2s;
}
.btn-add:hover { opacity: .85; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Stage Tabs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage-tabs {
    display: flex; overflow-x: auto; gap: 0;
    background: var(--s1);
    border-bottom: 1px solid var(--border);
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}
.stage-tabs::-webkit-scrollbar { display: none; }

.stage-tab {
    flex-shrink: 0;
    padding: 12px 16px;
    background: none; border: none;
    color: var(--dim); font-size: 13px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
    border-bottom: 2px solid transparent;
    transition: all .2s; position: relative;
}
.stage-tab.active { color: var(--text); }
.stage-tab[data-stage="all"].active    { border-bottom-color: var(--dim); }
.stage-tab[data-stage="new"].active    { border-bottom-color: var(--c-new);  color: var(--c-new); }
.stage-tab[data-stage="paid"].active   { border-bottom-color: var(--c-paid); color: var(--c-paid); }
.stage-tab[data-stage="ship"].active   { border-bottom-color: var(--c-ship); color: var(--c-ship); }
.stage-tab[data-stage="done"].active   { border-bottom-color: var(--c-done); color: var(--c-done); }

.tab-count {
    display: inline-flex; align-items: center; justify-content: center;
    width: 18px; height: 18px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%; font-size: 10px;
    margin-left: 5px; font-weight: 700;
}
.stage-tab.active .tab-count { background: currentColor; color: var(--bg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Stats Strip
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-strip {
    display: grid; grid-template-columns: repeat(4, 1fr);
    border-bottom: 1px solid var(--border);
    background: var(--s1);
}
.stat-cell {
    padding: 10px 8px; text-align: center;
    border-right: 1px solid var(--border);
}
.stat-cell:last-child { border-right: none; }
.stat-lbl { font-size: 10px; color: var(--dim); margin-bottom: 3px; }
.stat-val { font-size: 16px; font-weight: 700; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Search
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-bar {
    padding: 10px 16px;
    background: var(--s1);
    border-bottom: 1px solid var(--border);
}
.search-bar input {
    width: 100%; padding: 9px 14px;
    background: var(--s2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 14px; outline: none;
}
.search-bar input::placeholder { color: var(--dim); }
.search-bar input:focus { border-color: var(--blue); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Order Cards
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.order-list {
    padding: 12px 16px;
    display: flex; flex-direction: column; gap: 10px;
}
.empty-state {
    text-align: center; padding: 60px 20px; color: var(--dim);
}
.empty-icon { font-size: 40px; display: block; margin-bottom: 10px; }

.order-card {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 14px; overflow: hidden;
    transition: border-color .2s;
}
/* Stage left border */
.order-card[data-stage="new"]  { border-left: 3px solid var(--c-new); }
.order-card[data-stage="paid"] { border-left: 3px solid var(--c-paid); }
.order-card[data-stage="ship"] { border-left: 3px solid var(--c-ship); }
.order-card[data-stage="done"] { border-left: 3px solid var(--c-done); }
.order-card[data-stage="cancel"] { border-left: 3px solid var(--c-cancel); opacity: .6; }

.card-top {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 14px 10px; cursor: pointer;
}
.card-id  { font-size: 11px; color: var(--dim); flex-shrink: 0; }
.card-buyer { font-weight: 700; font-size: 15px; flex: 1; }
.card-date  { font-size: 11px; color: var(--dim); flex-shrink: 0; }
.stage-badge {
    font-size: 11px; padding: 3px 9px; border-radius: 10px;
    font-weight: 700; flex-shrink: 0;
}
.sb-new    { background: rgba(88,166,255,.15);  color: var(--c-new); }
.sb-paid   { background: rgba(210,153,34,.15);  color: var(--c-paid); }
.sb-ship   { background: rgba(168,85,247,.15);  color: var(--c-ship); }
.sb-done   { background: rgba(63,185,80,.15);   color: var(--c-done); }
.sb-cancel { background: rgba(110,118,129,.15); color: var(--c-cancel); }

.card-summary {
    padding: 0 14px 12px;
    display: flex; flex-wrap: wrap; gap: 10px;
    font-size: 13px;
}
.cs-item { display: flex; flex-direction: column; gap: 2px; }
.cs-lbl  { font-size: 10px; color: var(--dim); }
.cs-val  { font-weight: 600; }
.cs-val.profit-pos { color: var(--green); }
.cs-val.profit-neg { color: var(--red); }
.cs-val.profit-nil { color: var(--dim); }

/* Card Detail (expandable) */
.card-detail {
    display: none;
    border-top: 1px solid var(--border);
    padding: 14px;
    background: rgba(255,255,255,0.02);
}
.order-card.expanded .card-detail { display: block; }
.card-arrow { color: var(--dim); font-size: 11px; transition: transform .2s; flex-shrink: 0; }
.order-card.expanded .card-arrow { transform: rotate(180deg); }

/* Detail sections */
.detail-section { margin-bottom: 16px; }
.detail-title {
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: .5px; color: var(--dim); margin-bottom: 8px;
}
.detail-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
}
.detail-field { display: flex; flex-direction: column; gap: 3px; }
.detail-field.full { grid-column: 1 / -1; }
.df-label { font-size: 11px; color: var(--dim); }
.df-value { font-size: 14px; font-weight: 600; }
.df-value.dim { color: var(--dim); font-weight: 400; font-size: 13px; }

/* Action buttons */
.action-row {
    display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px;
}
.act-btn {
    flex: 1; padding: 10px 12px; border: none; border-radius: 9px;
    font-size: 13px; font-weight: 700; cursor: pointer;
    transition: opacity .2s; white-space: nowrap; min-width: 110px;
}
.act-btn:hover { opacity: .85; }
.act-btn:disabled { opacity: .35; cursor: default; }
.act-primary  { background: var(--blue);  color: white; }
.act-gold     { background: var(--gold);  color: white; }
.act-purple   { background: #a855f7;      color: white; }
.act-green    { background: var(--green); color: white; }
.act-danger   { background: transparent; color: var(--red); border: 1px solid rgba(233,69,96,.3); }
.act-ghost    { background: rgba(255,255,255,.06); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); z-index: 1000;
    justify-content: center; align-items: flex-end;
    padding: 0;
}
.modal-overlay.active { display: flex; }

.modal {
    background: var(--s1);
    border-radius: 20px 20px 0 0;
    border: 1px solid var(--border);
    border-bottom: none;
    width: 100%; max-width: 560px;
    max-height: 92vh;
    overflow-y: auto;
    padding: 0 0 30px;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    animation: slideUp .25s ease;
}
@keyframes slideUp {
    from { transform: translateY(60px); opacity: 0; }
    to   { transform: translateY(0);    opacity: 1; }
}
.modal-handle {
    width: 40px; height: 4px;
    background: var(--s3); border-radius: 2px;
    margin: 14px auto 0;
}
.modal-header {
    display: flex; align-items: center;
    padding: 16px 20px 10px;
    border-bottom: 1px solid var(--border);
    gap: 10px;
}
.modal-title { font-size: 17px; font-weight: 700; flex: 1; }
.modal-close {
    background: none; border: none; color: var(--dim);
    font-size: 20px; cursor: pointer; padding: 4px 8px;
    border-radius: 6px; transition: color .2s;
}
.modal-close:hover { color: var(--text); }
.modal-body { padding: 16px 20px; }

.form-group { margin-bottom: 14px; }
.form-group label {
    display: block; margin-bottom: 6px;
    font-size: 13px; font-weight: 600; color: var(--dim);
}
.form-group input,
.form-group select,
.form-group textarea {
    width: 100%; padding: 10px 14px;
    background: var(--s2); border: 1px solid var(--border);
    border-radius: 9px; color: var(--text); font-size: 15px; outline: none;
    transition: border-color .2s;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus { border-color: var(--blue); }
.form-group select option { background: var(--s2); }
.form-group textarea { resize: vertical; min-height: 70px; }
.form-group input::placeholder,
.form-group textarea::placeholder { color: var(--dim); }

/* Currency input */
.input-prefix-wrap { position: relative; }
.input-prefix {
    position: absolute; left: 12px; top: 50%;
    transform: translateY(-50%);
    font-size: 13px; font-weight: 700; pointer-events: none;
    color: var(--dim);
}
.input-prefix.cny { color: #e63946; }
.input-prefix.twd { color: var(--blue); }
.input-prefix-wrap input { padding-left: 36px; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* CNY Converter inside modal */
.cny-conv-box {
    display: none; margin-top: -8px; margin-bottom: 12px;
    padding: 10px 14px;
    background: rgba(230,57,70,.07);
    border: 1px solid rgba(230,57,70,.2);
    border-radius: 9px;
    align-items: center; gap: 8px; flex-wrap: wrap;
}
.cny-conv-box.visible { display: flex; }
.conv-result { font-size: 14px; font-weight: 700; color: var(--blue); }
.conv-rate   { font-size: 11px; color: var(--dim); }
.conv-apply  {
    margin-left: auto; background: var(--blue); color: white;
    border: none; border-radius: 7px; padding: 5px 12px;
    font-size: 12px; font-weight: 700; cursor: pointer;
}

/* Rate chip inside modal */
.rate-chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--s2); border: 1px solid var(--border);
    border-radius: 8px; padding: 6px 12px;
    font-size: 12px; color: var(--dim); margin-bottom: 14px;
}
.rate-chip strong { color: var(--blue); }

/* Profit preview */
.profit-preview {
    padding: 12px; border-radius: 9px;
    background: var(--s2); margin-bottom: 14px;
    display: none;
}
.profit-preview.visible { display: block; }
.pp-row {
    display: flex; justify-content: space-between;
    font-size: 13px; padding: 3px 0; color: var(--dim);
}
.pp-row.total {
    border-top: 1px solid var(--border);
    margin-top: 5px; padding-top: 8px;
    font-size: 15px; font-weight: 700; color: var(--text);
}
.pp-pos { color: var(--green); }
.pp-neg { color: var(--red); }

.modal-footer {
    padding: 0 20px;
    display: flex; gap: 10px;
}
.mf-btn {
    flex: 1; padding: 13px; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 700; cursor: pointer; transition: opacity .2s;
}
.mf-btn:hover { opacity: .85; }
.mf-btn:disabled { opacity: .4; cursor: default; }
.mf-primary { background: var(--blue); color: white; }
.mf-cancel  { background: var(--s2); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Bottom Nav
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(240,244,248,0.97);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    display: flex; height: 64px;
    z-index: 200;
}
.nav-item {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 3px;
    text-decoration: none; color: var(--dim);
    font-size: 10px; font-weight: 600;
    border: none; background: none; cursor: pointer;
    transition: color .2s;
}
.nav-item.active, .nav-item:hover  { color: var(--blue); }
.nav-icon { width: 22px; height: 22px; display: block; }
.nav-item.active .nav-icon, .nav-item:hover .nav-icon { stroke: var(--blue); }
.nav-icon svg { width: 100%; height: 100%; stroke: var(--dim); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; transition: stroke .2s; }
.nav-item.active .nav-icon svg, .nav-item:hover .nav-icon svg { stroke: var(--blue); }
    </style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">è¼‰å…¥ä¸­...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- â•â•â• Top Bar â•â•â• -->
<div class="topbar">
    <div class="topbar-title">ğŸ“‹ éŠ·å”®ç®¡ç†</div>
    <span class="topbar-badge" id="rate-chip-top">åŒ¯ç‡è¼‰å…¥ä¸­...</span>
    <button class="btn-add" onclick="openNewOrderModal()">ï¼‹ æ–°è¨‚å–®</button>
</div>

<!-- â•â•â• Stage Tabs â•â•â• -->
<div class="stage-tabs" id="stage-tabs">
    <button class="stage-tab active" data-stage="all"    onclick="setStage('all',this)">å…¨éƒ¨<span class="tab-count" id="cnt-all">0</span></button>
    <button class="stage-tab"       data-stage="new"    onclick="setStage('new',this)">ğŸ’¬ å¾…ç¢ºèª<span class="tab-count" id="cnt-new">0</span></button>
    <button class="stage-tab"       data-stage="paid"   onclick="setStage('paid',this)">ğŸ’° å·²æ”¶æ¬¾<span class="tab-count" id="cnt-paid">0</span></button>
    <button class="stage-tab"       data-stage="ship"   onclick="setStage('ship',this)">ğŸ“¦ å‡ºè²¨ä¸­<span class="tab-count" id="cnt-ship">0</span></button>
    <button class="stage-tab"       data-stage="done"   onclick="setStage('done',this)">âœ… å®Œæˆ<span class="tab-count" id="cnt-done">0</span></button>
</div>

<!-- â•â•â• Stats â•â•â• -->
<div class="stats-strip" id="stats-strip">
    <div class="stat-cell"><div class="stat-lbl">ç­†æ•¸</div><div class="stat-val" id="st-count">0</div></div>
    <div class="stat-cell"><div class="stat-lbl">éŠ·å”®é¡ TWD</div><div class="stat-val" id="st-sale" style="color:var(--blue)">$0</div></div>
    <div class="stat-cell"><div class="stat-lbl">æˆæœ¬ TWD</div><div class="stat-val" id="st-cost" style="color:var(--gold)">$0</div></div>
    <div class="stat-cell"><div class="stat-lbl">åˆ©æ½¤ TWD</div><div class="stat-val" id="st-profit">$0</div></div>
</div>

<!-- â•â•â• Search â•â•â• -->
<div class="search-bar">
    <input type="text" id="search-input" placeholder="ğŸ” æœå°‹è²·å®¶å§“å..." oninput="renderList()">
</div>

<!-- â•â•â• Order List â•â•â• -->
<div class="order-list" id="order-list">
    <div class="empty-state"><span class="empty-icon">ğŸ“­</span>è¼‰å…¥è¨‚å–®ä¸­...</div>
</div>

<!-- â•â•â• New / Edit Order Modal â•â•â• -->
<div class="modal-overlay" id="order-modal">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title" id="modal-title">æ–°è¨‚å–®</div>
            <button class="modal-close" onclick="closeOrderModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <!-- åŒ¯ç‡æç¤º -->
            <div class="rate-chip">
                ğŸ‡¨ğŸ‡³ å³æ™‚åŒ¯ç‡ï¼š<strong id="modal-rate-val">è¼‰å…¥ä¸­</strong> &nbsp;1 CNY = ? TWD
                <button onclick="fetchRate(true)" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px;margin-left:4px;">ğŸ”„</button>
            </div>

            <!-- Step 1: åŸºæœ¬ -->
            <div id="step-basic">
                <div class="form-group">
                    <label>ğŸ‘¤ è²·å®¶å§“å *</label>
                    <input type="text" id="f-buyer" placeholder="ä¾‹ï¼šç‹å°æ˜">
                </div>
                <div class="form-group">
                    <label>ğŸ“ å•†å“æè¿°ï¼ˆé¸å¡«ï¼‰</label>
                    <input type="text" id="f-product" placeholder="å•†å“åç¨±æˆ–å‚™è¨»">
                </div>
                <div class="form-group">
                    <label>ğŸ“… è¨‚å–®æ—¥æœŸ</label>
                    <input type="date" id="f-date">
                </div>
                <div class="form-group">
                    <label>ğŸ’µ éŠ·å”®é‡‘é¡ï¼ˆæ–°å°å¹£ TWDï¼‰*</label>
                    <div class="input-prefix-wrap">
                        <span class="input-prefix twd">NT$</span>
                        <input type="number" id="f-sale" placeholder="0" min="0" step="1" oninput="updateProfitPreview()">
                    </div>
                </div>

                <!-- æˆæœ¬ CNY -->
                <div class="form-group">
                    <label>ğŸ”´ å•†å“æˆæœ¬ï¼ˆäººæ°‘å¹£ CNYï¼‰</label>
                    <div class="input-prefix-wrap">
                        <span class="input-prefix cny">Â¥</span>
                        <input type="number" id="f-cost-cny" placeholder="0.00" min="0" step="0.01" oninput="onCnyChange()">
                    </div>
                </div>
                <!-- CNY æ›ç®— -->
                <div class="cny-conv-box" id="cny-conv">
                    <span id="cny-from" style="color:#e63946;font-weight:700;"></span>
                    <span style="color:var(--dim);">â†’</span>
                    <span class="conv-result" id="cny-to"></span>
                    <span class="conv-rate"   id="cny-rate-lbl"></span>
                    <button class="conv-apply" onclick="applyCnyConv()">å¥—ç”¨</button>
                </div>

                <div class="form-group">
                    <label>ğŸ’´ æˆæœ¬å°å¹£ TWDï¼ˆå¯æ‰‹å‹•å¡«æˆ–ç”±ä¸Šæ–¹æ›ç®—ï¼‰</label>
                    <div class="input-prefix-wrap">
                        <span class="input-prefix twd">NT$</span>
                        <input type="number" id="f-cost-twd" placeholder="0" min="0" step="1" oninput="updateProfitPreview()">
                    </div>
                </div>

                <!-- åˆ©æ½¤é è¦½ -->
                <div class="profit-preview" id="profit-preview">
                    <div class="pp-row"><span>éŠ·å”®é¡</span><span id="pp-sale">$0</span></div>
                    <div class="pp-row"><span>æˆæœ¬ï¼ˆå°å¹£ï¼‰</span><span id="pp-cost" style="color:var(--gold);">$0</span></div>
                    <div class="pp-row"><span>é‹è²»</span><span id="pp-sc" style="color:var(--gold);">å°šæœªå®‰æ’</span></div>
                    <div class="pp-row total"><span>é ä¼°åˆ©æ½¤</span><span id="pp-profit">$0</span></div>
                </div>

                <div class="form-group">
                    <label>ğŸ“Œ å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea id="f-note" placeholder="ä»»ä½•å‚™è¨»..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="mf-btn mf-cancel" onclick="closeOrderModal()">å–æ¶ˆ</button>
            <button class="mf-btn mf-primary" id="modal-save-btn" onclick="saveOrder()">âœ“ å»ºç«‹è¨‚å–®</button>
        </div>
    </div>
</div>

<!-- â•â•â• Ship Modalï¼ˆå‡ºè²¨å®‰æ’ï¼‰â•â•â• -->
<div class="modal-overlay" id="ship-modal">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title">ğŸ“¦ å®‰æ’å‡ºè²¨ â€” <span id="ship-buyer"></span></div>
            <button class="modal-close" onclick="closeShipModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>è²¨é‹æ–¹å¼</label>
                    <select id="sh-type">
                        <option value="7-11">7-11 è¶…å•†å–è²¨</option>
                        <option value="å…¨å®¶">å…¨å®¶ è¶…å•†å–è²¨</option>
                        <option value="å®…é…">å®…é…åˆ°åºœ</option>
                        <option value="é¢äº¤">é¢äº¤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é‹è²» NT$</label>
                    <div class="input-prefix-wrap">
                        <span class="input-prefix twd">NT$</span>
                        <input type="number" id="sh-cost" value="60" min="0" step="1" oninput="updateShipPreview()">
                    </div>
                </div>
            </div>
            <div class="form-group" id="sh-store-group">
                <label>é–€å¸‚ / é–€å¸‚ä»£ç¢¼</label>
                <input type="text" id="sh-store" placeholder="ä¾‹ï¼šä¸­å£¢ä¸­æ­£é–€å¸‚">
            </div>
            <div class="form-group" id="sh-addr-group" style="display:none">
                <label>å®Œæ•´æ”¶ä»¶åœ°å€</label>
                <textarea id="sh-addr" placeholder="ç¸£å¸‚å€è·¯è™Ÿ"></textarea>
            </div>
            <div class="form-group">
                <label>æ”¶ä»¶äººï¼ˆè‹¥ä¸åŒæ–¼è²·å®¶ï¼‰</label>
                <input type="text" id="sh-receiver" placeholder="ç•™ç©ºå‰‡åŒè²·å®¶">
            </div>
            <div class="form-group">
                <label>é›»è©±</label>
                <input type="tel" id="sh-phone" placeholder="09xx-xxxxxx">
            </div>
            <div class="form-group">
                <label>å‡ºè²¨å‚™è¨»</label>
                <input type="text" id="sh-note" placeholder="ä¾‹ï¼šæ˜“ç¢å“è«‹å°å¿ƒ">
            </div>

            <!-- åˆ©æ½¤æ›´æ–°é è¦½ -->
            <div class="profit-preview visible" id="ship-profit-preview">
                <div class="pp-row"><span>éŠ·å”®é¡</span><span id="spp-sale">$0</span></div>
                <div class="pp-row"><span>å•†å“æˆæœ¬</span><span id="spp-cost" style="color:var(--gold)">$0</span></div>
                <div class="pp-row"><span>é‹è²»</span><span id="spp-sc" style="color:var(--gold)">$0</span></div>
                <div class="pp-row total"><span>æœ€çµ‚åˆ©æ½¤</span><span id="spp-profit">$0</span></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="mf-btn mf-cancel" onclick="closeShipModal()">å–æ¶ˆ</button>
            <button class="mf-btn mf-primary" id="ship-save-btn" onclick="saveShipping()">ğŸ“¦ ç¢ºèªå‡ºè²¨</button>
        </div>
    </div>
</div>

<!-- â•â•â• Bottom Nav â•â•â• -->
<div class="bottom-nav">
    <button class="nav-item active" onclick="showPage('orders',this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></span>è¨‚å–®
    </button>
    <button class="nav-item" onclick="showPage('stats',this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>çµ±è¨ˆ
    </button>
    <button class="nav-item" onclick="window.location.href='../index.html'">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>èˆŠç‰ˆ
    </button>
</div>

<!-- â•â•â• Stats Page (hidden by default) â•â•â• -->
<div id="page-stats" style="display:none; padding:16px 16px 80px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;" id="stats-cards"></div>
    <div style="background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;">
        <div style="font-size:12px;font-weight:700;color:var(--dim);margin-bottom:12px;">ğŸ“… æ¯æœˆåˆ©æ½¤</div>
        <div id="monthly-chart"></div>
    </div>
    <div style="background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;">
        <div style="font-size:12px;font-weight:700;color:var(--dim);margin-bottom:12px;">ğŸ† è²·å®¶æ’è¡Œï¼ˆåˆ©æ½¤ï¼‰</div>
        <div id="buyer-chart"></div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://script.google.com/macros/s/AKfycbzWdfBTJ9k8OSk3FF6I-Hwr3QoiLGlCgZVBQqdZMwacxQVaEszIYS_4kcBZ8ZB-6Aa2tA/exec';

const RATE_APIS = [
    'https://api.frankfurter.app/latest?from=CNY&to=TWD',
    'https://open.er-api.com/v6/latest/CNY'
];
const RATE_KEY    = 'v2_cny_twd';
const RATE_TS_KEY = 'v2_cny_twd_ts';
const RATE_TTL    = 30 * 60 * 1000;

const ORDERS_KEY = 'v2_orders'; // localStorage

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let orders     = [];   // All orders
let cnyRate    = null; // 1 CNY = ? TWD
let curStage   = 'all';
let editingId  = null; // modal edit mode
let shipTarget = null; // order being shipped

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Boot
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function boot() {
    loadOrders();
    await Promise.all([
        fetchRate(false),
        syncFromSheets()
    ]);
    renderList();
    hideLoading();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Orders â€“ localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadOrders() {
    try {
        orders = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');
    } catch(e) { orders = []; }
}

function persistOrders() {
    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
}

function nextId() {
    const max = orders.reduce((m, o) => Math.max(m, parseInt(o.id) || 0), 0);
    return String(max + 1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync from Google Sheets (read existing data)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncFromSheets() {
    try {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 20000);
        const res = await fetch(API_URL, { signal: ctrl.signal });
        clearTimeout(t);
        if (!res.ok) return;
        const json = await res.json();
        // æ–°ç‰ˆ Apps Script å›å‚³ { status, data: [...] }ï¼ŒèˆŠç‰ˆç›´æ¥å›å‚³é™£åˆ—
        const raw = Array.isArray(json) ? json : (json.data || []);

        // å°‡èˆŠç‰ˆè³‡æ–™åˆä½µï¼ˆåªåŠ å…¥ localStorage æ²’æœ‰çš„ idï¼‰
        const existIds = new Set(orders.map(o => o.id));
        let added = 0;
        raw.forEach(d => {
            const id = String(d.id || '');
            if (!id || existIds.has(id)) return;
            // è½‰æ›æˆæ–°æ ¼å¼
            orders.push({
                id,
                buyer:       String(d.buyer || ''),
                product:     '',
                date:        String(d.date || ''),
                sale:        0,
                costCny:     0,
                costTwd:     0,
                shippingCost: (() => { const m = String(d.shipping||'').match(/\((\d+)\)/); return m ? parseInt(m[1]) : 0; })(),
                shippingType: (() => { const s = String(d.shipping||''); if (s.includes('7-11')) return '7-11'; if (s.includes('å…¨å®¶')) return 'å…¨å®¶'; if (s.includes('å®…é…')) return 'å®…é…'; return 'å…¶ä»–'; })(),
                store:       String(d.region || ''),
                address:     String(d.full_address || ''),
                note:        '',
                stage:       'done',  // èˆŠè³‡æ–™é è¨­ç‚ºå®Œæˆ
                createdAt:   d.date || '',
                paidAt:      '',
                shippedAt:   '',
                doneAt:      ''
            });
            existIds.add(id);
            added++;
        });
        if (added > 0) {
            persistOrders();
            showToast(`ğŸ“¥ å¾èˆŠç‰ˆåŒ¯å…¥ ${added} ç­†`, 'ok');
        }
    } catch(e) { /* éœé»˜å¤±æ•— */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Exchange Rate
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchRate(force = false) {
    if (!force) {
        const cached = localStorage.getItem(RATE_KEY);
        const ts = parseInt(localStorage.getItem(RATE_TS_KEY) || '0');
        if (cached && Date.now() - ts < RATE_TTL) {
            cnyRate = parseFloat(cached);
            updateRateUI();
            return;
        }
    }
    for (const url of RATE_APIS) {
        try {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), 7000);
            const res = await fetch(url, { signal: ctrl.signal });
            clearTimeout(t);
            if (!res.ok) continue;
            const j = await res.json();
            const r = j.rates && j.rates.TWD;
            if (r) {
                cnyRate = parseFloat(r);
                localStorage.setItem(RATE_KEY, cnyRate);
                localStorage.setItem(RATE_TS_KEY, Date.now());
                updateRateUI();
                if (force) showToast(`âœ… åŒ¯ç‡å·²æ›´æ–°ï¼š1Â¥ = ${cnyRate.toFixed(4)} NT$`, 'ok');
                return;
            }
        } catch(e) {}
    }
    const cached = localStorage.getItem(RATE_KEY);
    cnyRate = cached ? parseFloat(cached) : 4.43;
    updateRateUI();
    if (force) showToast('âš ï¸ ç„¡æ³•æ›´æ–°åŒ¯ç‡ï¼Œä½¿ç”¨å¿«å–', 'err');
}

function updateRateUI() {
    const txt = cnyRate ? `1Â¥ = ${cnyRate.toFixed(4)} NT$` : '--';
    document.getElementById('rate-chip-top').textContent = txt;
    document.getElementById('modal-rate-val').textContent = cnyRate ? cnyRate.toFixed(4) : '--';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Stage filter
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStage(s, btn) {
    curStage = s;
    document.querySelectorAll('.stage-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    renderList();
}

function getFiltered() {
    const q = document.getElementById('search-input').value.toLowerCase().trim();
    return orders.filter(o => {
        if (curStage !== 'all' && o.stage !== curStage) return false;
        if (q && !o.buyer.toLowerCase().includes(q) && !o.id.includes(q)) return false;
        return true;
    }).sort((a, b) => b.id.localeCompare(a.id, undefined, { numeric: true }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderList() {
    updateCounts();
    const rows = getFiltered();
    updateStats(rows);
    const el = document.getElementById('order-list');
    if (!rows.length) {
        el.innerHTML = '<div class="empty-state"><span class="empty-icon">ğŸ“­</span>é€™è£¡é‚„æ²’æœ‰è¨‚å–®</div>';
        return;
    }
    el.innerHTML = rows.map(o => buildCard(o)).join('');
}

function updateCounts() {
    const cnt = { new:0, paid:0, ship:0, done:0 };
    orders.forEach(o => { if (cnt[o.stage] !== undefined) cnt[o.stage]++; });
    document.getElementById('cnt-all').textContent  = orders.length;
    document.getElementById('cnt-new').textContent  = cnt.new;
    document.getElementById('cnt-paid').textContent = cnt.paid;
    document.getElementById('cnt-ship').textContent = cnt.ship;
    document.getElementById('cnt-done').textContent = cnt.done;
}

function updateStats(rows) {
    let totSale = 0, totCost = 0, totProfit = 0;
    rows.forEach(o => {
        totSale   += o.sale    || 0;
        totCost   += (o.costTwd || 0) + (o.shippingCost || 0);
        totProfit += (o.sale || 0) - (o.costTwd || 0) - (o.shippingCost || 0);
    });
    document.getElementById('st-count').textContent  = rows.length;
    document.getElementById('st-sale').textContent   = '$' + totSale.toLocaleString();
    document.getElementById('st-cost').textContent   = '$' + totCost.toLocaleString();
    const profitEl = document.getElementById('st-profit');
    profitEl.textContent = (totProfit >= 0 ? '+$' : '-$') + Math.abs(totProfit).toLocaleString();
    profitEl.style.color = totProfit > 0 ? 'var(--green)' : totProfit < 0 ? 'var(--red)' : 'var(--dim)';
}

function buildCard(o) {
    const stageLbl = { new:'ğŸ’¬ å¾…ç¢ºèª', paid:'ğŸ’° å·²æ”¶æ¬¾', ship:'ğŸ“¦ å‡ºè²¨ä¸­', done:'âœ… å®Œæˆ', cancel:'å–æ¶ˆ' };
    const stageCls = { new:'sb-new', paid:'sb-paid', ship:'sb-ship', done:'sb-done', cancel:'sb-cancel' };
    const profit = (o.sale || 0) - (o.costTwd || 0) - (o.shippingCost || 0);
    const hasFinance = o.sale > 0 || o.costTwd > 0;
    const profitCls = !hasFinance ? 'profit-nil' : profit > 0 ? 'profit-pos' : profit < 0 ? 'profit-neg' : 'profit-nil';
    const profitTxt = !hasFinance ? 'â€“' : (profit >= 0 ? '+$' : '-$') + Math.abs(profit).toLocaleString();

    return `
<div class="order-card" data-stage="${o.stage}" id="card-${o.id}">
    <div class="card-top" onclick="toggleCard('${o.id}')">
        <span class="card-id">#${o.id}</span>
        <span class="card-buyer">${o.buyer}</span>
        <span class="stage-badge ${stageCls[o.stage]}">${stageLbl[o.stage]||o.stage}</span>
        <span class="card-date">${o.date||''}</span>
        <span class="card-arrow">â–¼</span>
    </div>
    <div class="card-summary">
        ${o.sale ? `<div class="cs-item"><span class="cs-lbl">å”®åƒ¹</span><span class="cs-val" style="color:var(--blue)">NT$${o.sale.toLocaleString()}</span></div>` : ''}
        ${o.costTwd ? `<div class="cs-item"><span class="cs-lbl">æˆæœ¬</span><span class="cs-val" style="color:var(--gold)">NT$${o.costTwd.toLocaleString()}${o.costCny ? ` (Â¥${o.costCny})` : ''}</span></div>` : ''}
        ${hasFinance ? `<div class="cs-item"><span class="cs-lbl">åˆ©æ½¤</span><span class="cs-val ${profitCls}">${profitTxt}</span></div>` : ''}
        ${o.shippingType ? `<div class="cs-item"><span class="cs-lbl">è²¨é‹</span><span class="cs-val">${o.shippingType}${o.shippingCost ? ` NT$${o.shippingCost}` : ''}</span></div>` : ''}
        ${o.store ? `<div class="cs-item"><span class="cs-lbl">é–€å¸‚/åœ°å€</span><span class="cs-val">${o.store}</span></div>` : ''}
    </div>
    <div class="card-detail" id="detail-${o.id}">
        ${buildDetail(o)}
    </div>
</div>`;
}

function buildDetail(o) {
    const profit = (o.sale || 0) - (o.costTwd || 0) - (o.shippingCost || 0);
    const profitCls = profit > 0 ? 'pp-pos' : profit < 0 ? 'pp-neg' : '';

    let actions = '';

    if (o.stage === 'new') {
        actions = `
            <button class="act-btn act-gold" onclick="confirmPaid('${o.id}')">ğŸ’° ç¢ºèªæ”¶æ¬¾</button>
            <button class="act-btn act-ghost" onclick="editOrder('${o.id}')">âœï¸ ç·¨è¼¯</button>
            <button class="act-btn act-danger" onclick="cancelOrder('${o.id}')">âœ• å–æ¶ˆ</button>`;
    } else if (o.stage === 'paid') {
        actions = `
            <button class="act-btn act-purple" onclick="openShipModal('${o.id}')">ğŸ“¦ å®‰æ’å‡ºè²¨</button>
            <button class="act-btn act-ghost" onclick="editOrder('${o.id}')">âœï¸ ç·¨è¼¯é‡‘é¡</button>`;
    } else if (o.stage === 'ship') {
        actions = `
            <button class="act-btn act-green" onclick="confirmDone('${o.id}')">âœ… ç¢ºèªå®Œæˆ</button>
            <button class="act-btn act-ghost" onclick="openShipModal('${o.id}')">âœï¸ ä¿®æ”¹å‡ºè²¨è³‡æ–™</button>`;
    } else if (o.stage === 'done') {
        actions = `<button class="act-btn act-ghost" onclick="editOrder('${o.id}')">âœï¸ æŸ¥çœ‹/ç·¨è¼¯</button>`;
    }

    return `
    <div class="detail-section">
        <div class="detail-title">è¨‚å–®è³‡è¨Š</div>
        <div class="detail-grid">
            <div class="detail-field"><span class="df-label">è²·å®¶</span><span class="df-value">${o.buyer}</span></div>
            <div class="detail-field"><span class="df-label">æ—¥æœŸ</span><span class="df-value">${o.date||'â€“'}</span></div>
            ${o.product ? `<div class="detail-field full"><span class="df-label">å•†å“</span><span class="df-value">${o.product}</span></div>` : ''}
            ${o.note ? `<div class="detail-field full"><span class="df-label">å‚™è¨»</span><span class="df-value dim">${o.note}</span></div>` : ''}
        </div>
    </div>
    <div class="detail-section">
        <div class="detail-title">å¸³å‹™</div>
        <div class="detail-grid">
            <div class="detail-field"><span class="df-label">å”®åƒ¹ TWD</span><span class="df-value" style="color:var(--blue)">${o.sale ? 'NT$' + o.sale.toLocaleString() : 'â€“'}</span></div>
            <div class="detail-field"><span class="df-label">æˆæœ¬ CNY</span><span class="df-value" style="color:#e63946">${o.costCny ? 'Â¥' + o.costCny : 'â€“'}</span></div>
            <div class="detail-field"><span class="df-label">æˆæœ¬ TWD</span><span class="df-value" style="color:var(--gold)">${o.costTwd ? 'NT$' + o.costTwd.toLocaleString() : 'â€“'}</span></div>
            <div class="detail-field"><span class="df-label">é‹è²» TWD</span><span class="df-value">${o.shippingCost ? 'NT$' + o.shippingCost : 'â€“'}</span></div>
            <div class="detail-field full">
                <span class="df-label">åˆ©æ½¤</span>
                <span class="df-value ${profit>0?'pp-pos':profit<0?'pp-neg':''}" style="font-size:16px;">
                    ${o.sale > 0 ? (profit >= 0 ? '+' : '') + 'NT$' + profit.toLocaleString() : 'â€“'}
                </span>
            </div>
        </div>
    </div>
    ${o.shippingType ? `
    <div class="detail-section">
        <div class="detail-title">å‡ºè²¨è³‡è¨Š</div>
        <div class="detail-grid">
            <div class="detail-field"><span class="df-label">è²¨é‹æ–¹å¼</span><span class="df-value">${o.shippingType}</span></div>
            <div class="detail-field"><span class="df-label">æ”¶ä»¶äºº</span><span class="df-value">${o.receiver || o.buyer}</span></div>
            ${o.phone ? `<div class="detail-field"><span class="df-label">é›»è©±</span><span class="df-value">${o.phone}</span></div>` : ''}
            ${o.store ? `<div class="detail-field full"><span class="df-label">é–€å¸‚ / åœ°å€</span><span class="df-value">${o.store}${o.address ? '<br>' + o.address : ''}</span></div>` : ''}
            ${o.shipNote ? `<div class="detail-field full"><span class="df-label">å‡ºè²¨å‚™è¨»</span><span class="df-value dim">${o.shipNote}</span></div>` : ''}
        </div>
    </div>` : ''}
    <div class="action-row">${actions}</div>`;
}

function toggleCard(id) {
    const card = document.getElementById('card-' + id);
    card.classList.toggle('expanded');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  New / Edit Order Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewOrderModal() {
    editingId = null;
    document.getElementById('modal-title').textContent = 'ï¼‹ æ–°è¨‚å–®';
    document.getElementById('modal-save-btn').textContent = 'âœ“ å»ºç«‹è¨‚å–®';

    // Reset
    const today = new Date();
    document.getElementById('f-buyer').value    = '';
    document.getElementById('f-product').value  = '';
    document.getElementById('f-date').value     = today.toISOString().slice(0,10);
    document.getElementById('f-sale').value     = '';
    document.getElementById('f-cost-cny').value = '';
    document.getElementById('f-cost-twd').value = '';
    document.getElementById('f-note').value     = '';
    document.getElementById('cny-conv').classList.remove('visible');
    document.getElementById('profit-preview').classList.remove('visible');

    document.getElementById('order-modal').classList.add('active');
}

function editOrder(id) {
    const o = orders.find(x => x.id === id);
    if (!o) return;
    editingId = id;
    document.getElementById('modal-title').textContent = `âœï¸ ç·¨è¼¯ #${id} ${o.buyer}`;
    document.getElementById('modal-save-btn').textContent = 'âœ“ å„²å­˜ä¿®æ”¹';

    document.getElementById('f-buyer').value    = o.buyer;
    document.getElementById('f-product').value  = o.product || '';
    document.getElementById('f-date').value     = normalizeDate(o.date);
    document.getElementById('f-sale').value     = o.sale || '';
    document.getElementById('f-cost-cny').value = o.costCny || '';
    document.getElementById('f-cost-twd').value = o.costTwd || '';
    document.getElementById('f-note').value     = o.note || '';

    onCnyChange();
    updateProfitPreview();
    document.getElementById('order-modal').classList.add('active');
}

function closeOrderModal() {
    document.getElementById('order-modal').classList.remove('active');
    editingId = null;
}

function normalizeDate(d) {
    if (!d) return '';
    // M/D/YYYY â†’ YYYY-MM-DD
    const m1 = d.match(/^(\d+)\/(\d+)\/(\d{4})$/);
    if (m1) return `${m1[3]}-${m1[1].padStart(2,'0')}-${m1[2].padStart(2,'0')}`;
    return d.slice(0,10);
}

async function saveOrder() {
    const buyer = document.getElementById('f-buyer').value.trim();
    if (!buyer) { showToast('âš ï¸ è«‹å¡«å¯«è²·å®¶å§“å', 'err'); return; }

    const dateVal = document.getElementById('f-date').value;
    const sale    = parseFloat(document.getElementById('f-sale').value)     || 0;
    const costCny = parseFloat(document.getElementById('f-cost-cny').value) || 0;
    const costTwd = parseFloat(document.getElementById('f-cost-twd').value) || 0;

    // è‹¥æœ‰ CNY ä½†æ²’æ‰‹å‹•å¡« TWDï¼Œè‡ªå‹•æ›ç®—
    const finalCostTwd = costTwd > 0 ? costTwd : (costCny > 0 && cnyRate ? Math.round(costCny * cnyRate) : 0);

    const btn = document.getElementById('modal-save-btn');
    btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

    if (editingId) {
        const idx = orders.findIndex(o => o.id === editingId);
        if (idx >= 0) {
            orders[idx] = { ...orders[idx],
                buyer, sale, costCny, costTwd: finalCostTwd,
                product: document.getElementById('f-product').value.trim(),
                date: dateVal, note: document.getElementById('f-note').value.trim()
            };
        }
        syncOrderToSheets(orders[idx], true);
        showToast(`âœ… #${editingId} å·²æ›´æ–°`, 'ok');
    } else {
        const id = nextId();
        orders.unshift({
            id, buyer, sale, costCny, costTwd: finalCostTwd,
            product: document.getElementById('f-product').value.trim(),
            date: dateVal, note: document.getElementById('f-note').value.trim(),
            stage: 'new',
            shippingCost: 0, shippingType: '', store: '', address: '',
            receiver: '', phone: '', shipNote: '',
            createdAt: new Date().toISOString(), paidAt: '', shippedAt: '', doneAt: ''
        });
        // Push to Sheets
        syncOrderToSheets(orders[0]);
        showToast(`âœ… è¨‚å–® #${id} å·²å»ºç«‹`, 'ok');
    }

    persistOrders();
    closeOrderModal();
    renderList();
    btn.disabled = false;
    btn.textContent = editingId ? 'âœ“ å„²å­˜ä¿®æ”¹' : 'âœ“ å»ºç«‹è¨‚å–®';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Stage transitions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmPaid(id) {
    const o = orders.find(x => x.id === id);
    if (!o) return;
    if (!o.sale) {
        if (!confirm('å°šæœªå¡«å¯«éŠ·å”®é‡‘é¡ï¼Œç¢ºå®šè¦æ¨™è¨˜ç‚ºå·²æ”¶æ¬¾å—ï¼Ÿ')) return;
    }
    o.stage  = 'paid';
    o.paidAt = new Date().toISOString();
    persistOrders();
    syncStageToSheets(id, 'paid');
    renderList();
    showToast(`ğŸ’° #${id} ${o.buyer} å·²æ”¶æ¬¾`, 'ok');
}

function confirmDone(id) {
    const o = orders.find(x => x.id === id);
    if (!o) return;
    o.stage  = 'done';
    o.doneAt = new Date().toISOString();
    persistOrders();
    syncStageToSheets(id, 'done');
    renderList();
    showToast(`âœ… #${id} ${o.buyer} å·²å®Œæˆ`, 'ok');
}

function cancelOrder(id) {
    if (!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†è¨‚å–®ï¼Ÿ')) return;
    const o = orders.find(x => x.id === id);
    if (!o) return;
    o.stage = 'cancel';
    persistOrders();
    renderList();
    showToast(`âœ• #${id} å·²å–æ¶ˆ`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ship Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openShipModal(id) {
    const o = orders.find(x => x.id === id);
    if (!o) return;
    shipTarget = id;
    document.getElementById('ship-buyer').textContent = `${o.buyer} (#${id})`;
    document.getElementById('sh-type').value    = o.shippingType || '7-11';
    document.getElementById('sh-cost').value    = o.shippingCost || 60;
    document.getElementById('sh-store').value   = o.store || '';
    document.getElementById('sh-addr').value    = o.address || '';
    document.getElementById('sh-receiver').value= o.receiver || '';
    document.getElementById('sh-phone').value   = o.phone || '';
    document.getElementById('sh-note').value    = o.shipNote || '';
    onShipTypeChange();
    updateShipPreview();
    document.getElementById('ship-modal').classList.add('active');
}

function closeShipModal() {
    document.getElementById('ship-modal').classList.remove('active');
    shipTarget = null;
}

document.getElementById('sh-type').addEventListener('change', onShipTypeChange);
function onShipTypeChange() {
    const t = document.getElementById('sh-type').value;
    const isHome = t === 'å®…é…';
    document.getElementById('sh-store-group').style.display = isHome ? 'none' : '';
    document.getElementById('sh-addr-group').style.display  = isHome ? '' : 'none';
    if (t === 'å®…é…') {
        document.getElementById('sh-cost').value = 100;
    } else if (t === 'é¢äº¤') {
        document.getElementById('sh-cost').value = 0;
    } else {
        document.getElementById('sh-cost').value = 60;
    }
    updateShipPreview();
}

function updateShipPreview() {
    if (!shipTarget) return;
    const o = orders.find(x => x.id === shipTarget);
    if (!o) return;
    const sc = parseFloat(document.getElementById('sh-cost').value) || 0;
    const profit = (o.sale || 0) - (o.costTwd || 0) - sc;
    document.getElementById('spp-sale').textContent   = 'NT$' + (o.sale || 0).toLocaleString();
    document.getElementById('spp-cost').textContent   = '- NT$' + (o.costTwd || 0).toLocaleString();
    document.getElementById('spp-sc').textContent     = '- NT$' + sc.toLocaleString();
    const profitEl = document.getElementById('spp-profit');
    profitEl.textContent = (profit >= 0 ? '+' : '') + 'NT$' + profit.toLocaleString();
    profitEl.className = profit > 0 ? 'pp-pos' : profit < 0 ? 'pp-neg' : '';
}

async function saveShipping() {
    const id = shipTarget;
    const o = orders.find(x => x.id === id);
    if (!o) return;

    const btn = document.getElementById('ship-save-btn');
    btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

    const t = document.getElementById('sh-type').value;
    o.shippingType = t;
    o.shippingCost = parseFloat(document.getElementById('sh-cost').value) || 0;
    o.store        = t === 'å®…é…' ? '' : document.getElementById('sh-store').value.trim();
    o.address      = t === 'å®…é…' ? document.getElementById('sh-addr').value.trim() : '';
    o.receiver     = document.getElementById('sh-receiver').value.trim();
    o.phone        = document.getElementById('sh-phone').value.trim();
    o.shipNote     = document.getElementById('sh-note').value.trim();
    o.stage        = 'ship';
    o.shippedAt    = new Date().toISOString();

    persistOrders();
    syncShipToSheets(o);
    closeShipModal();
    renderList();
    showToast(`ğŸ“¦ #${id} å‡ºè²¨è³‡æ–™å·²å„²å­˜`, 'ok');
    btn.disabled = false; btn.textContent = 'ğŸ“¦ ç¢ºèªå‡ºè²¨';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CNY Converter (modal)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onCnyChange() {
    const cny = parseFloat(document.getElementById('f-cost-cny').value) || 0;
    const box  = document.getElementById('cny-conv');
    if (cny > 0 && cnyRate) {
        const twd = Math.round(cny * cnyRate);
        document.getElementById('cny-from').textContent   = 'Â¥' + cny.toLocaleString();
        document.getElementById('cny-to').textContent     = 'NT$' + twd.toLocaleString();
        document.getElementById('cny-rate-lbl').textContent = `(åŒ¯ç‡ ${cnyRate.toFixed(4)})`;
        box.classList.add('visible');
    } else {
        box.classList.remove('visible');
    }
    updateProfitPreview();
}

function applyCnyConv() {
    const cny = parseFloat(document.getElementById('f-cost-cny').value) || 0;
    if (cny > 0 && cnyRate) {
        document.getElementById('f-cost-twd').value = Math.round(cny * cnyRate);
        updateProfitPreview();
        showToast('âœ… å·²å¥—ç”¨æ›ç®—çµæœ', 'ok');
    }
}

function updateProfitPreview() {
    const sale    = parseFloat(document.getElementById('f-sale').value)     || 0;
    const costTwd = parseFloat(document.getElementById('f-cost-twd').value) || 0;
    const preview = document.getElementById('profit-preview');
    if (!sale && !costTwd) { preview.classList.remove('visible'); return; }
    preview.classList.add('visible');
    const profit = sale - costTwd;
    document.getElementById('pp-sale').textContent   = 'NT$' + sale.toLocaleString();
    document.getElementById('pp-cost').textContent   = '- NT$' + costTwd.toLocaleString();
    const profitEl = document.getElementById('pp-profit');
    profitEl.textContent = (profit >= 0 ? '+' : '') + 'NT$' + profit.toLocaleString();
    profitEl.className = profit > 0 ? 'pp-pos' : profit < 0 ? 'pp-neg' : '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Google Sheets Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncOrderToSheets(o, isEdit = false) {
    try {
        await fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: isEdit ? 'updateOrderV2' : 'addV2',
                id: o.id, buyer: o.buyer,
                date: o.date, product: o.product,
                sale: o.sale, costCny: o.costCny,
                costTwd: o.costTwd, stage: o.stage,
                shippingCost: o.shippingCost,
                shippingType: o.shippingType,
                store: o.store, address: o.address,
                receiver: o.receiver, phone: o.phone,
                shipNote: o.shipNote, note: o.note,
                createdAt: o.createdAt, paidAt: o.paidAt,
                shippedAt: o.shippedAt, doneAt: o.doneAt
            })
        });
    } catch(e) {}
}

async function syncShipToSheets(o) {
    try {
        await fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'updateShipV2', id: o.id,
                stage: o.stage,
                shippingType: o.shippingType,
                shippingCost: o.shippingCost,
                store: o.store, address: o.address,
                receiver: o.receiver, phone: o.phone,
                shipNote: o.shipNote,
                shippedAt: o.shippedAt
            })
        });
    } catch(e) {}
}

async function syncStageToSheets(id, stage) {
    try {
        await fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'updateStageV2', id, stage })
        });
    } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Stats Page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name, btn) {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const ol = document.getElementById('order-list');
    const sp = document.getElementById('page-stats');
    const tb = document.querySelector('.stage-tabs');
    const ss = document.getElementById('stats-strip');
    const sb = document.querySelector('.search-bar');
    if (name === 'stats') {
        ol.style.display = 'none'; sp.style.display = 'block';
        tb.style.display = 'none'; ss.style.display = 'none'; sb.style.display = 'none';
        renderStats();
    } else {
        ol.style.display = ''; sp.style.display = 'none';
        tb.style.display = ''; ss.style.display = ''; sb.style.display = '';
    }
}

function renderStats() {
    renderStatsCards();
    renderMonthlyChart();
    renderBuyerChart();
}

function renderStatsCards() {
    const done = orders.filter(o => o.stage === 'done' || o.stage === 'ship');
    let sale = 0, cost = 0, profit = 0;
    done.forEach(o => {
        sale   += o.sale || 0;
        cost   += (o.costTwd || 0) + (o.shippingCost || 0);
        profit += (o.sale || 0) - (o.costTwd || 0) - (o.shippingCost || 0);
    });
    const margin = sale > 0 ? Math.round(profit / sale * 100) : 0;
    document.getElementById('stats-cards').innerHTML = `
        <div style="background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:var(--dim);margin-bottom:4px;">ç¸½éŠ·å”®é¡</div>
            <div style="font-size:20px;font-weight:700;color:var(--blue)">$${sale.toLocaleString()}</div>
        </div>
        <div style="background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:var(--dim);margin-bottom:4px;">ç¸½æˆæœ¬</div>
            <div style="font-size:20px;font-weight:700;color:var(--gold)">$${cost.toLocaleString()}</div>
        </div>
        <div style="background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:var(--dim);margin-bottom:4px;">ç¸½åˆ©æ½¤</div>
            <div style="font-size:20px;font-weight:700;color:${profit>=0?'var(--green)':'var(--red)'}">${profit>=0?'+':'-'}$${Math.abs(profit).toLocaleString()}</div>
        </div>
        <div style="background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:11px;color:var(--dim);margin-bottom:4px;">åˆ©æ½¤ç‡</div>
            <div style="font-size:20px;font-weight:700;color:var(--purple)">${margin}%</div>
        </div>`;
}

function renderMonthlyChart() {
    const map = {};
    orders.forEach(o => {
        if (!o.sale && !o.costTwd) return;
        const m = (o.date||'').match(/^(\d+)\//);
        const y = (o.date||'').match(/^\d{4}-0?(\d+)/);
        const key = m ? m[1]+'æœˆ' : (y ? parseInt(y[1])+'æœˆ' : '?');
        if (!map[key]) map[key] = 0;
        map[key] += (o.sale||0) - (o.costTwd||0) - (o.shippingCost||0);
    });
    const entries = Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0],undefined,{numeric:true}));
    const maxV = Math.max(...entries.map(([,v])=>Math.abs(v)), 1);
    document.getElementById('monthly-chart').innerHTML = entries.length
        ? entries.map(([k,v]) => `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <div style="width:50px;font-size:12px;color:var(--dim);text-align:right;">${k}</div>
                <div style="flex:1;background:var(--s3);border-radius:4px;overflow:hidden;">
                    <div style="height:24px;width:${Math.round(Math.abs(v)/maxV*90)}%;background:${v>=0?'linear-gradient(90deg,#1f6feb,#3fb950)':'var(--red)'};border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;color:white;font-size:12px;font-weight:700;min-width:60px;">
                        ${v>=0?'+':'-'}$${Math.abs(v).toLocaleString()}
                    </div>
                </div>
            </div>`)
        .join('')
        : '<div style="color:var(--dim);font-size:13px;text-align:center;padding:20px;">å°šç„¡è³‡æ–™</div>';
}

function renderBuyerChart() {
    const map = {};
    orders.forEach(o => {
        if (!o.sale && !o.costTwd) return;
        const p = (o.sale||0) - (o.costTwd||0) - (o.shippingCost||0);
        map[o.buyer] = (map[o.buyer]||0) + p;
    });
    const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const maxV = Math.max(...top.map(([,v])=>Math.abs(v)), 1);
    document.getElementById('buyer-chart').innerHTML = top.length
        ? top.map(([name,v]) => `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <div style="width:60px;font-size:12px;color:var(--dim);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${name}">${name}</div>
                <div style="flex:1;background:var(--s3);border-radius:4px;overflow:hidden;">
                    <div style="height:24px;width:${Math.round(Math.abs(v)/maxV*90)}%;background:${v>=0?'linear-gradient(90deg,#059669,#4cd964)':'var(--red)'};border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;color:white;font-size:12px;font-weight:700;min-width:60px;">
                        ${v>=0?'+':'-'}$${Math.abs(v).toLocaleString()}
                    </div>
                </div>
            </div>`)
        .join('')
        : '<div style="color:var(--dim);font-size:13px;text-align:center;padding:20px;">å°šç„¡è³‡æ–™</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg, type='') {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = 'toast show' + (type ? ' ' + type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}
document.getElementById('toast').addEventListener('click', () => {
    clearTimeout(toastTimer);
    document.getElementById('toast').classList.remove('show');
});
function showLoading(txt) {
    document.getElementById('loading-text').textContent = txt||'è™•ç†ä¸­...';
    document.getElementById('loading').classList.remove('hidden');
}
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

// Close modals on outside tap
document.getElementById('order-modal').addEventListener('click', e => { if (e.target === document.getElementById('order-modal')) closeOrderModal(); });
document.getElementById('ship-modal').addEventListener('click',  e => { if (e.target === document.getElementById('ship-modal'))  closeShipModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Start
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
showLoading('å•Ÿå‹•ä¸­...');
boot();
</script>
</body>
</html>
